dependencies:
  pre:
    - wget https://releases.hashicorp.com/terraform/0.7.5/terraform_0.7.5_linux_amd64.zip
    - unzip -o terraform_0.7.5_linux_amd64.zip
    - wget https://releases.hashicorp.com/packer/0.10.2/packer_0.10.2_linux_amd64.zip
    - unzip -o packer_0.10.2_linux_amd64.zip

test:
  override:
    - ./packer validate assets/packer/ubuntu/16.04.json
    - ./terraform remote config -backend=S3 -backend-config="bucket=terraform-state-helpscout-demo" -backend-config="key=terraform.tfstate" -backend-config="region=us-east-1"
    - ./terraform get assets/terraform/hs
    - HAPROXY_AMI=$(cat amis.txt | awk -F: '{print $2}' | tail -1) NGINX_AMI=$(cat amis.txt | awk -F: '{print $2}' | head -1) ./terraform plan -out=terraform.plan -var 'aws_credential_profile=default' -var 'nginx_ami=ami-b66922a1' -var 'haproxy_ami=ami-c8561ddf' assets/terraform/hs

deployment:
  production:
    branch: master
    commands:
      - HAPROXY_AMI=$(cat amis.txt | awk -F: '{print $2}' | tail -1) NGINX_AMI=$(cat amis.txt | awk -F: '{print $2}' | head -1) ./terraform apply -var 'aws_credential_profile=default' -var 'nginx_ami=$NGINX_AMI' -var 'haproxy_ami=$HAPROXY_AMI' assets/terraform/hs
